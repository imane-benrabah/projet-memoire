<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affecter responsabilite</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/affectation_respons.css">
   
    
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
    <h2 class="titre">Gestion projet</h2>
    <nav>
        <ul>
            <li>
                <a href="dashboard_r.html">
                    <i class="fas fa-tachometer-alt"></i>  Dashboard
                </a>
            </li>
            <li class="active"><a href="consulter_binome_r.html"><i class="fas fa-users"></i> Voir Binômes</a></li>

            <li  >
                <a href="decrire_sujet.html">
                    <i class="fas fa-eye"></i>  Decrire sujet
                </a>
            </li>

            <li>
                <a href="preciser_sujet.html">
                    <i class="fas fa-tasks"></i> Gestion Etape
                </a>
            </li>
            <li >
                <a href="preciser_cas.html">
                    <i class="fas fa-tasks"></i> Preciser cas
                </a>
            </li>
            <li >
                <a href="organiser_reunion.html">
                    <i class="fas fa-calendar-check"></i> Organiser Reunion
                </a>
            </li>
            <li  >
                <a href="consulter_rap_ens_res.html">
                    <i class="fas fa-eye"></i> Voir Rapport
                </a>
            </li>

            <li ><a href="consulter_question.html"><i class="fas fa-comments"></i> Voir Question</a></li>


            <li >
                <a href="voir_profil_r.html">
                    <i class="fas fa-user"></i> Voir profil
                </a>
            </li>
        </ul>
    </nav>
</aside>
<div class="form-container">
    <h1>Affectation des Responsabilités</h1>
    
    <form id="affectationForm">
        <div class="form-group">
            <label for="binome-select">binôme selectionné :</label>
            <input type="text" id="binome-input" class="form-control" readonly>
        </div>
        
        <div class="form-group">
            <label for="responsabilite-select">Affecter une responsabilité :</label>
            <select id="responsabilite-select" class="form-control" required>
                <option value="">-- Sélectionner une responsabilité --</option>
                <option value="responsable étape">responsable étape</option>
                <option value="responsable mémoire">responsable memoire</option>
                <option value="responsable introduction et conclusion">responsable introduction et conclusion</option>
                <option value="responsable résumé">responsable résumé</option>
              
            </select>
        </div>
        
        <div class="button-group">
            <button type="button" class="btn cancel-btn">Annuler</button>
            <button type="submit" class="btn submit-btn">Valider l'affectation</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Récupération des données
    const selectedGroupe = localStorage.getItem('selectedGroupe');
    const selectedBinomeNum = localStorage.getItem('selectedBinomeNum') || 
                            localStorage.getItem('lastSelectedBinome');
    const selectedGroupeName = localStorage.getItem('selectedGroupeName');
    
    // Vérification
    console.log("Données du localStorage:", {
        groupe: selectedGroupe,
        binome: selectedBinomeNum,
        groupeName: selectedGroupeName
    });

    if (!selectedBinomeNum) {
        alert('Veuillez d\'abord sélectionner un binôme sur la page précédente');
        window.location.href = 'consulter_binome_r.html';
        return;
    }

    // Mise à jour de l'interface
    const title = document.querySelector('h1');
    const binomeInput = document.getElementById('binome-input');
    
    if (selectedGroupeName) {
        title.textContent = `Affectation des Responsabilités - Groupe ${selectedGroupeName}`;
    }
    binomeInput.value = `${selectedBinomeNum}`;

    // Gestion du formulaire
    const form = document.getElementById('affectationForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const responsabilite = document.getElementById('responsabilite-select').value;
        if (!responsabilite) {
            alert('Veuillez sélectionner une responsabilité');
            return;
        }
        
        fetch('http://localhost:3000/api/affecter-responsabilite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                binome: selectedBinomeNum,
                responsabilite: responsabilite,
                groupe: selectedGroupe
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Responsabilité affectée avec succès au binôme ${selectedBinomeNum}`);
                form.reset();
            } else {
                throw new Error(data.message || 'Erreur lors de l\'affectation');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert(`Erreur: ${error.message}`);
        });
    });
    
    // Bouton Annuler
    document.querySelector('.cancel-btn').addEventListener('click', function() {
        window.location.href = 'affectation_r.html'; // Correction de la faute de frappe
    });
});


fetch('http://localhost:3000/api/affecter-responsabilite', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    binome: selectedBinomeNum,
    responsabilite: responsabilite,
    groupe: selectedGroupe
  })
})
.then(response => response.json())
.then(data => {
  if (data.success) {
    alert(data.message);
    form.reset();
  } else {
    if (confirm(data.message + '\nVoulez-vous modifier la responsabilité existante?')) {
      // Envoyer une requête de modification
      fetch('http://localhost:3000/api/modifier-responsabilite', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          binome: selectedBinomeNum,
          nouvelleResponsabilite: responsabilite,
          groupe: selectedGroupe
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.message);
          form.reset();
        } else {
          alert(data.message || 'Échec de la modification');
        }
      })
      .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue lors de la modification');
      });
    }
  }
})
.catch(error => {
  console.error('Erreur:', error);
  alert(`Erreur: ${error.message}`);
});

</script>


</body>
</html>