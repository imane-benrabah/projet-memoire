<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créer Groupe</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/creer_groupe.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <h2 class="titre">Gestion projet</h2>
        <nav>
            <ul>
                <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li class="active"><a href="creer_groupe.html"><i class="fas fa-users"></i> Créer groupes</a></li>
                <li><a href="voir_groupe.html"><i class="fas fa-eye"></i> Voir groupe</a></li>
                <li><a href="voir_profil.html"><i class="fas fa-user"></i> Voir profil</a></li>
            </ul>
        </nav>
    </aside>

    <main>
        <h1>Liste des binômes</h1>
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-primary">
                    <tr>
                        <th>Numéro</th>
                        <th>Matricule</th>
                        <th>Nom</th>
                        <th>Prénom</th>
                    </tr>
                </thead>
                <tbody id="table-binomes">
                    <!-- Les binômes seront affichés ici dynamiquement -->
                </tbody>
            </table>
        </div>

        <button id="btn-creer-groupe" class="btn btn-success mt-3" data-bs-toggle="modal" data-bs-target="#modalGroupe">
            Créer Groupe
        </button>
    </main>

    <!-- Fenêtre modale pour la création de groupe -->
    <div class="modal fade" id="modalGroupe" tabindex="-1" aria-labelledby="modalGroupeLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalGroupeLabel">Créer un Groupe</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-groupe">
                        <div class="mb-3">
                            <label for="binome_id" class="form-label">Choisir un binôme</label>
                            <select class="form-control" id="binome_id" required>
                                <option value="">Sélectionnez un binôme</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="groupe_nom" class="form-label">Choisir un Groupe</label>
                            <select class="form-control" id="groupe_nom" required>
                                <option value="">Sélectionnez un groupe</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="creer">Créer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Gestion du menu actif
            const menuItems = document.querySelectorAll('.sidebar nav ul li');
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    menuItems.forEach(li => li.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Déclaration des éléments
            const tableBody = document.getElementById("table-binomes");
            const selectBinome = document.getElementById("binome_id");
            const selectGroupe = document.getElementById("groupe_nom");
            const formGroupe = document.getElementById("form-groupe");

            // Fonction pour charger les binômes
            function chargerBinomes() {
                fetch("http://localhost:3000/api/binomes")
                    .then(response => {
                        if (!response.ok) throw new Error('Erreur réseau');
                        return response.json();
                    })
                    .then(binomes => {
                        tableBody.innerHTML = "";
                        selectBinome.innerHTML = '<option value="">Sélectionnez un binôme</option>';

                        binomes.forEach(binome => {
                            // Ajout au tableau
                            const row1 = document.createElement("tr");
                            row1.innerHTML = `
                                <td rowspan="${binome.etudiant2_nom ? 2 : 1}">${binome.binome_id}</td>
                                <td>${binome.etudiant1_matricule || "N/A"}</td>
                                <td>${binome.etudiant1_nom || "Inconnu"}</td>
                                <td>${binome.etudiant1_prenom || ""}</td>
                            `;
                            tableBody.appendChild(row1);

                            if (binome.etudiant2_nom) {
                                const row2 = document.createElement("tr");
                                row2.innerHTML = `
                                    <td>${binome.etudiant2_matricule || "N/A"}</td>
                                    <td>${binome.etudiant2_nom || "Inconnu"}</td>
                                    <td>${binome.etudiant2_prenom || ""}</td>
                                `;
                                tableBody.appendChild(row2);
                            }

                            // Ajout au select
                            const option = document.createElement("option");
                            option.value = binome.binome_id;
                            option.textContent = `Binôme ${binome.binome_id}`;
                            selectBinome.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Erreur lors du chargement des binômes:", error);
                        alert("Erreur lors du chargement des binômes");
                    });
            }

            // Fonction pour charger les groupes
            function chargerGroupes() {
                fetch("http://localhost:3000/api/groupes")
                    .then(response => {
                        if (!response.ok) throw new Error('Erreur réseau');
                        return response.json();
                    })
                    .then(groupes => {
                        selectGroupe.innerHTML = '<option value="">Sélectionnez un groupe</option>';
                        groupes.forEach(groupe => {
                            const option = document.createElement("option");
                            option.value = groupe.nom_groupe;
                            option.textContent = groupe.nom_groupe;
                            selectGroupe.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error("Erreur lors du chargement des groupes:", error);
                        alert("Erreur lors du chargement des groupes");
                    });
            }

            // Gestion du formulaire
            formGroupe.addEventListener("submit", function(event) {
                event.preventDefault();

                const binomeId = selectBinome.value;
                const groupeNom = selectGroupe.value;

                if (!binomeId || !groupeNom) {
                    alert("Veuillez sélectionner un binôme ET un groupe !");
                    return;
                }

                fetch("http://localhost:3000/api/binomes/associer", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        binome_id: binomeId,
                        groupe_nom: groupeNom
                    })
                })
                .then(response => {
                    if (!response.ok) throw new Error('Erreur serveur');
                    return response.json();
                })
                .then(data => {
                    alert("Binôme associé au groupe avec succès !");
                    // Fermer la modale
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalGroupe'));
                    modal.hide();
                    // Recharger les données
                    chargerBinomes();
                })
                .catch(error => {
                    console.error("Erreur:", error);
                    alert("Erreur lors de l'association: " + error.message);
                });
            });

            // Chargement initial
            chargerBinomes();
            chargerGroupes();
        });
    </script>
</body>
</html>