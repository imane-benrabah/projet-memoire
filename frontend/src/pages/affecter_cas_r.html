<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>affecter cas</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/affecter_cas_r.css">
    <style>
   .case-item {
    padding: 10px;
    margin: 5px 0;
    border: 1px solid #ddd;
    border-radius: 4px;
    display: flex;
    align-items: center;
}

.case-item input[type="checkbox"] {
    margin-right: 10px;
}

.case-affecte {
    background-color: #f8f9fa;
    color: #6c757d;
}

#selected-cases ul {
    list-style-type: none;
    padding: 0;
}

#selected-cases li {
    padding: 8px;
    background-color: #e9ecef;
    margin-bottom: 5px;
    border-radius: 4px;
}

.affectation-container {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

.list-container, .selected-container {
    flex: 1;
    padding: 15px;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    background-color: white;
}

.btn-container {
    margin-top: 20px;
    text-align: right;
}



    </style>
   
</head>
<body>

    <!-- Sidebar -->
    <div class="wrapper">
           <!-- Sidebar -->
  <div class="sidebar">
    <h2 class="titre">Gestion projet</h2>
    <nav>
      <ul>
        <li><a href="dashboard_r.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li class="active"><a href="consulter_binome_r.html"><i class="fas fa-users"></i> Voir Binômes</a></li>
        <li><a href="decrire_sujet.html"><i class="fas fa-file-alt"></i> Décrire Sujet</a></li>
        <li><a href="preciser_sujet.html"><i class="fas fa-tasks"></i> Gestion Étape</a></li>
        <li >
            <a href="preciser_cas.html">
                <i class="fas fa-tasks"></i> Preciser cas
            </a>
        </li>
        <li><a href="organiser_reunion.html"><i class="fas fa-calendar-check"></i> Organiser Réunion</a></li>
        <li ><a href="consulter_rap_ens_res.html"><i class="fas fa-eye"></i> Voir Rapport</a></li>
        <li><a href="consulter_question.html"><i class="fas fa-comments"></i> Voir Question</a></li>
        <li><a href="voir_profil_r.html"><i class="fas fa-user"></i> Voir Profil</a></li>
      </ul>
    </nav>
    </div>

     <div class="content">
            <div class="binome-selection">
                <label for="binome-select">Binôme sélectionné :</label>
                <input type="text" id="binome-input" class="form-control" readonly>
            </div>
            <div class="acteur-selection">
                <label for="acteur-select"></label>
                <select id="acteur-select" class="form-control" required>
                    <option value="">Sélectionner un acteur</option>
                    <!-- Options seront ajoutées dynamiquement -->
                </select>
            </div>
            
            <div class="affectation-container">
                <div class="list-container">
                    <h5>Cas disponibles :</h5>
                    <div id="case-list">
                        <!-- Cas seront ajoutés dynamiquement -->
                    </div>
                </div>
                <div class="selected-container">
                    <h5>Cas sélectionnés :</h5>
                    <div id="selected-cases"></div>
                </div>
            </div>
            
            <div class="btn-container">
                <button id="envoyer-btn" class="btn btn-primary">Envoyer</button>
                <button id="annuler-btn" class="btn btn-secondary">Annuler</button>
            </div>
        </div>
    </div>
   <script>
document.addEventListener('DOMContentLoaded', function() {
    // Éléments du DOM
    const binomeInput = document.getElementById('binome-input');
    const acteurSelect = document.getElementById('acteur-select');
    const caseList = document.getElementById('case-list');
    const selectedCasesDiv = document.getElementById('selected-cases');
    const envoyerBtn = document.getElementById('envoyer-btn');
    const annulerBtn = document.getElementById('annuler-btn');

    // Variables globales
    let selectedBinomeId = null;
    let availableCases = [];
    let availableActeurs = [];

    // Initialisation
    initPage();

    // Événements
    acteurSelect.addEventListener('change', filterCasesByActeur);
    envoyerBtn.addEventListener('click', envoyerAffectation);
    annulerBtn.addEventListener('click', annuler);

    // Fonctions
    function initPage() {
        selectedBinomeId = localStorage.getItem('selectedBinomeNum');
        
        if (!selectedBinomeId) {
            alert('Veuillez d\'abord sélectionner un binôme');
            window.location.href = 'consulter_binome_r.html';
            return;
        }

        binomeInput.value = `Binôme ${selectedBinomeId}`;
        
        // Charger les cas et acteurs disponibles
        chargerCasEtActeurs();
    }

    function chargerCasEtActeurs() {
        fetch(`http://localhost:3000/api/cas-et-acteurs?binome=${selectedBinomeId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    availableCases = data.data.cas;
                    availableActeurs = data.data.acteurs;
                    
                    // Remplir le selecteur d'acteurs
                    populateActeurSelect();
                    
                    // Afficher tous les cas initialement
                    displayCases(availableCases);
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors du chargement des données');
            });
    }

    function populateActeurSelect() {
        acteurSelect.innerHTML = '<option value="">Tous les acteurs</option>';
        
        availableActeurs.forEach(acteur => {
            const option = document.createElement('option');
            option.value = acteur;
            option.textContent = acteur;
            acteurSelect.appendChild(option);
        });
    }

    function filterCasesByActeur() {
        const selectedActeur = acteurSelect.value;
        
        if (!selectedActeur) {
            displayCases(availableCases);
            return;
        }
        
        const filteredCases = availableCases.filter(cas => cas.acteur === selectedActeur);
        displayCases(filteredCases);
    }

    function displayCases(cases) {
        caseList.innerHTML = '';
        
        if (cases.length === 0) {
            caseList.innerHTML = '<p>Aucun cas disponible</p>';
            return;
        }
        
        cases.forEach(cas => {
            const div = document.createElement('div');
            div.className = 'case-item';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `cas-${cas.idCas}`;
            checkbox.value = cas.idCas;
            checkbox.dataset.cas = JSON.stringify(cas);
            
            const label = document.createElement('label');
            label.htmlFor = `cas-${cas.idCas}`;
        label.textContent = cas.cas;
            
            if (cas.statut === 'affecté') {
                checkbox.disabled = true;
                div.classList.add('case-affecte');
                label.textContent += ' (Déjà affecté)';
            }
            
            checkbox.addEventListener('change', updateSelectedCases);
            
            div.appendChild(checkbox);
            div.appendChild(label);
            caseList.appendChild(div);
        });
    }

    function updateSelectedCases() {
        selectedCasesDiv.innerHTML = '';
        const checkboxes = document.querySelectorAll('#case-list input[type="checkbox"]:checked:not(:disabled)');
        
        if (checkboxes.length === 0) {
            selectedCasesDiv.innerHTML = '<p>Aucun cas sélectionné</p>';
            return;
        }
        
        const ul = document.createElement('ul');
        checkboxes.forEach(checkbox => {
            const cas = JSON.parse(checkbox.dataset.cas);
            const li = document.createElement('li');
            li.textContent = `${cas.acteur}: ${cas.cas}`;
            ul.appendChild(li);
        });
        
        selectedCasesDiv.appendChild(ul);
    }

    function envoyerAffectation() {
        const checkboxes = document.querySelectorAll('#case-list input[type="checkbox"]:checked:not(:disabled)');
        
        if (checkboxes.length === 0) {
            alert('Veuillez sélectionner au moins un cas');
            return;
        }
        
        const casesToAffect = Array.from(checkboxes).map(checkbox => checkbox.value);
        
        fetch('http://localhost:3000/api/affecter-cas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                binome: selectedBinomeId,
                cas: casesToAffect
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Recharger les données
                chargerCasEtActeurs();
                selectedCasesDiv.innerHTML = '<p>Aucun cas sélectionné</p>';
            } else {
                throw new Error(data.message);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert(`Erreur: ${error.message}`);
        });
    }

    function annuler() {
        window.location.href = 'consulter_binome_r.html';
    }
});
</script>

</body>
</html>
